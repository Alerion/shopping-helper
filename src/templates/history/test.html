<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>backbone</title>

  
  <link rel="stylesheet" type="text/css" href="../../static/bootstrap-v3.0.0-rc1/css/bootstrap.min.css"/>
  <link rel="stylesheet" type="text/css" href="../../static/css/history.css"/>
</head>
<body>  
  
  
  <script src="http://cdnjs.cloudflare.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js" type="text/javascript"></script>
  <script src="http://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.0.0/backbone-min.js"></script>


<script type="text/template" id="item-template">

  <div class = 'checkbox'>
    <input type='checkbox' class = 'check' checked='checked'/>
    <a><%=name%></a>
  </div>
</script>


<script type="text/template" id="product-time-template">
  <div><%=name%></div>
</script>

<script type="text/template" id="shopping-list-template">
    <div class="module-day" style='height:<%=days%>px'></div>
    <div class='date'><%=date%></div>
    <ul class="sl_products_container">
        <button type="button" class="close popups" >&times;</button>
        <div class='triangle'></div>
    </ul>
    <div class='circle'><div class = 'small-circle'></div></div>
</script>


<script type="text/template" id="category-item">
        <li>
            <h3>
            <div class="icon-download up_down"></div>
            <input class="category_check" type="checkbox" checked = "checked">
              <%=name%>
            </h3>
            <ul>
            </ul>
        </li>
</script>


<div id='accordian'>
</div> 

<div id='timeLine'>
</div> 

 <script type="text/javascript">



$(document).ready(function() {
    

  $.ajaxPrefilter( function( options, originalOptions, jqXHR ) {
      options.url = 'http://127.0.0.1:8000/api' + options.url;

});
//************************Models*******************************//


    var Category  = Backbone.Model.extend({

      urlRoot: '/categories/',
      defaults: {
          //'products': "nyaka"
      }
    });

    var Product = Backbone.Model.extend({

        defaults: {
            //'categoryId' : null,
            //'checked' : true,
            //'current' : false,
            //'lists' : ""
        },

        //initialize: function(){
            //this.set('categoryId',this.get("category").id);    
        //}
     

    });

    var ShoppingList = Backbone.Model.extend({
         defaults: {
        'products' : [],
    },

        urlRoot : '/shopping_lists/'
    });

    


    ///*************Collections**********************/


    var Products = Backbone.Collection.extend({
        model: Product,
        url : '/products/?format=json'

    })

    var Categories = Backbone.Collection.extend({
      model: Category,
      url : '/categories/?format=json',
      comparator: 'id'
    })

    var TimeLine = Backbone.Collection.extend({

      url : '/shopping_lists/',
      comparator: 'date',
      model:ShoppingList,
      
    })

    



    //**********************Views****************************// 



 

    var ProductTimeView = Backbone.View.extend({
        tagName:  "li",
        template : _.template($('#product-time-template').html()),
        initialize: function() {
            this.listenTo(localProducts, 'all', this.render);
        },    
        events: {
          //"click .checked"   : "test"
        },
        render: function() {
            console.log(this.model)
            this.$el.html(this.template(this.model.toJSON()));

            //міняємо класи взалежності від атрибута моделі 'checked'
           // var flag = localProducts.where({id:this.model.get('id')[0]});//alwys true
            flag = localProducts.get(this.model.get('id'))
            if(flag) {
                
                this.$el.removeClass('hide');
                this.$el.addClass('show');
            } else {
                this.$el.removeClass('show');
                this.$el.addClass('hide');
           }
            return this;
         
       }
        
    })

//КОЖЕН ліст МАЄ СЛУХАТИ СВОЇ ВЛАСНІ ПРОДУКТИ
//модель передається в вид
    var ShoppingListView = Backbone.View.extend({
        className : 'shopping-list',
        template :_.template($('#shopping-list-template').html()),
        initialize: function() {
          this.listenTo(localProducts, 'all', this.sumCount);
        },
        events: {
          "mouseenter .circle"   : "showPopup",
          "click .popups"       : "hidePopup"
        },
        //object.listenTo(other, event, callback)  ОДИН ОБЄКТ МОЖЕ СЛУХАТИ ІНШИЙ ЯКЩО ВОНИ ВОП ЯЗАНІ
        render : function(){
            var that = this;
            that.$el.html(this.template(this.model.toJSON()));
            var products = that.model.get('products');  
                _.each(products,function(product){
                    var pr = new Product(product)
                    var view = new ProductTimeView({model: pr});
                    that.$el.find('.sl_products_container').append(view.render().el);
                });
            that.sumCount();
        return that;
        },
       sumCount: function(){
            var sum =0;
            var pattern = [50,100,200,400,800,1000,1500,2000,3000, 1000000000]
            var products = this.model.get('products');
            var circle = this.$el.find('.circle')
            var smallCircle = this.$el.find('.small-circle')
            var ids =localProducts.pluck('id') 
            console.log(ids)
            _.each(products,function(product){

                //$.inArray(product.id, ids)
                if(ids.indexOf(product.id)!=-1){
                    sum+=Number(product.price);
                    console.log(product.price+ ''+ product.name)
                

                } else {console.log(ids.indexOf(product.id))}

                //define class of circle
                circle.removeClass();
                circle.addClass('circle');
                for(var i = 0; i < pattern.length; i++) {
                    if(sum < pattern[i]) {
                        circle.addClass('size-' + i);
                        break;
                    }

                }
            })
            smallCircle.text(sum);
            this.checkEmpty();
        },
        showPopup : function(){
            $('#timeLine').find('.sl_products_container').hide();
            this.$el.find('.sl_products_container').show();
        },
        hidePopup : function(){
           this.$el.find('.sl_products_container').hide(); 
        },
        checkEmpty : function(){
            var ids =localProducts.pluck('id')
            var products = this.model.get('products');
            var visible = []
            for (var i = 0; i < products.length; i++){
                if(ids.indexOf(products[i].id)!=-1) {
                    visible.push(i)
                }
            }
            if(visible.length == 0) {
                this.$el.hide();
            } else {
                this.$el.show();
            }
        }
    })



    var TimeLineView = Backbone.View.extend({
        el : '#timeLine',
        render : function(){
            var that= this;
            //that.$el.empty();

            var prod = []
            var timeLine = new TimeLine();
            var nextDate = new Date(); //current date
            timeLine.fetch({ 
                success : function() {
                    //сортуємо моделі по спаданню дати
                    _.each(timeLine.models.reverse(), function(shoppingList){
                            prod = [];
                            var date = shoppingList.get('date');
                        if (date) {
                            //визначення відстані в днях
                            var time = date.split('-');
                            var curDate = new Date()
                            curDate.setFullYear(time[0],time[1]-1,time[2]);
                            var dumyDade = new Date(nextDate - curDate);
                            var days = dumyDade.getDate()*20;
                            nextDate = curDate;
                                shoppingList.set("days",days);
                                var shoppingListView = new ShoppingListView({model:shoppingList});
                                that.$el.append(shoppingListView.render().el);
                        }
                      })
                },
                error : function(){
                    console.log('You are ...')
                }
            });  
        }
    })

   
    var ProductView = Backbone.View.extend({

        tagName:  "li",
        events: {
            // check/uncheck change product model
            "click .check"   : "toggleCheck", 
        },

        render: function() {
            var template = _.template($('#item-template').html())
            this.$el.html(template(this.model.toJSON()));
            return this;

        },
        toggleCheck : function(){
            var flag = this.$el.find('.check').is(':checked');
            //тут ми маємо видаляти анчекнуті продукти з  колекції локалпродакт, або додаємо чекнуті
            if(flag) {
                localProducts.add(this.model) 
            } else {
                localProducts.remove(this.model)
            }
            //кожен внутрішній чекнутий  чекбокс на всякий випадок чекає і зовнішній чекбокс 
            if(flag) {
                this.$el.parents('ul').find('.category_check').prop('checked',true)
            }

        }
    })



    var CategoryView = Backbone.View.extend({
        tagName : 'ul',
        events: {
            "click .category_check"   : "toggleCheck", 
            'click .up_down' : 'up_down',
            'click .check' : 'uncheck'
        },
      
        toggleCheck : function (){

            var checked = this.$el.find('.category_check').is(':checked');

            if (checked){
                this.$el.find('.check').prop('checked', true);

                _.each(this.model.get("products"), function(product){
                    localProducts.add(product);
                });
            }
            else{
                 this.$el.find('.check').prop('checked', false);

                  _.each(this.model.get("products"), function(product){
                    localProducts.remove(product);
                });
            }

      },

      render: function(){
       that = this
        var template = _.template($('#category-item').html())
        this.$el.append(template(this.model.toJSON()));
        //here we render all products for this category
        _.each (this.model.get("products"), function(product){
              var view = new ProductView({model: product});
              that.$el.find('ul').append(view.render().el);
        });
        return this;

      },
      //анчекає категорію, в якій немає чекнутих продуктів
    uncheck: function(){
        //alert('123')
        var checked = this.$el.find('.check:checked');
        if(checked.length == 0) {
            this.$el.find('.category_check').prop('checked',false);
        }

    },
        up_down : function (){
            if(this.$el.flag === 1) {
            this.$el.find('ul').slideUp();
            this.$el.find('.up_down').removeClass('icon-upload')
            this.$el.find('.up_down').addClass('icon-download')
            this.$el.flag = 0;
            } else {
                this.$el.find('ul').slideDown();
                this.$el.flag = 1;
                this.$el.find('.up_down').removeClass('icon-download')
                this.$el.find('.up_down').addClass('icon-upload')
            }
        }


    })

    //робоча версія
    var MenuView = Backbone.View.extend({
        el : "#accordian",
        events: {
            
        },
        render : function(){
            var that = this;
            categories = new Categories();
            categories.fetch({
                success: function(){

                      _.each(categories.models, function(category){
                        var pr = [];
                            var categoryId = category.id 
                            //populate  current catergory with appropriate products
                            var products = new Products()
                            products.fetch({
                                success: function(){

                                    pr = [];
                                    _.each(products.models, function(product){
                                        if(product.get('category').id == categoryId)
                                        {
                                            console.log(product.get('id'))
                                            pr.push(product)
                                        }
                                    })
                                    category.set("products",pr);
                                    var categoryView = new CategoryView({model:category});
                                    that.$el.append(categoryView.render().el);
                                }
                            })
                        })
                }

            });
        }
    })


     
    var localProducts = new  Products(); 
    //var localShoppingLists = new  ShoppingLists(); 
    var localCategories = new Categories(); 

   //Рендеримо меню коли дочекаємось завантаження колекції продуктів
    localProducts.fetch({
        success: function(){

            var menuView = new MenuView();
            menuView.render();

            var timeLineView = new TimeLineView();
            timeLineView.render();
        }
    });


   
//продукти зникають по анчеку+
//продукти  з являлися по чеку +
//потрібно зробити, щоб shopping-list рахував суми+
//потрібно, щоб виводилася дата+
//*потрібно вибирати тільки ті лісти в яких є дата
//класи кружочків+

//відстані між кружочками*****+



//якщо всі продукти категорії порожні -- категорія анчекається+
//якщо хоч один продукт категорії чекнутий -- категорія чекнута+


//зникнення і поява шоппінг ліст по наведенні+
//зникнення шоппінг ліст по кліку на кнопку - хрестик+
//перевірка кружочків на порожність -- порожній кружок зникає +



//shopping-list  профільтрований по порядку +, 
//не містить list з відсутньою датою
//помісти цифри по центру

///не анчекається категорія -- коли всі продукти анчекнуті
})

    </script>

</body>
</html>
