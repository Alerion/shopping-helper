from django.contrib.auth.decorators import login_required
from django.template.response import TemplateResponse
from models import Product, ShoppingList, Dashboard, Category
from django import forms
from django.http import HttpResponseRedirect

@login_required
def index(request):
    list1=Product.objects.all()
    user=request.user # define who is logged in
    f=AddForm(request.POST)
    currUserDashboard = request.user.getDashboard()
    currBuyList = ShoppingList.objects.filter(dashboard = currUserDashboard)
    categories_select = Category.objects.all()
    print unicode(currUserDashboard)

    if request.method == 'POST': # If the form has been submitted...
        form = AddForm(request.POST) # A form bound to the POST datas
        if form.is_valid(): # All validation rules pass
            obj = form.save(commit=False)
            obj.dashboard = currUserDashboard
            obj.save()
            #currBuyList.add_product(obj)
            return HttpResponseRedirect(request.get_full_path()) # Redirect after POST
    else:
        form = AddForm() # An unbound form

    context = {'listproduct': list1 ,
               'currUserDashboard': currUserDashboard,
               'currBuyList': currBuyList,
               'user': user,
               'test': f,
               'categories_select': categories_select,
               'form': form}
    return TemplateResponse(request, 'main/index.html', context)


class AddForm(forms.ModelForm):

    class Meta:
        model = Product
        fields = ('name', 'category')

